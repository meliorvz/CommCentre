# T-033: Phone Provisioning Backend

| Field | Value |
|-------|-------|
| **Status** | ðŸ”´ BLOCKED |
| **Round** | 3 |
| **Blocked By** | T-015 âœ…, T-016 âœ… |
| **Effort** | 4-5 hours |
| **Assignee** | _____________ |

---

## Background

Backend API for Twilio number provisioning.

---

## Implementation

```typescript
// GET /api/twilio/available-numbers
app.get('/api/twilio/available-numbers', authMiddleware, async (c) => {
    const areaCode = c.req.query('areaCode');
    const client = getTwilioClient(c.env);
    
    const numbers = await client.availablePhoneNumbers('AU')
        .local
        .list({ areaCode, limit: 10 });
    
    return c.json(numbers.map(n => ({
        phoneNumber: n.phoneNumber,
        friendlyName: n.friendlyName,
        locality: n.locality,
        capabilities: n.capabilities,
    })));
});

// POST /api/twilio/provision
app.post('/api/twilio/provision', authMiddleware, async (c) => {
    const { phoneNumber } = await c.req.json();
    const companyId = c.get('companyId');
    const client = getTwilioClient(c.env);
    
    // Purchase the number
    const purchased = await client.incomingPhoneNumbers.create({
        phoneNumber,
        smsUrl: `${c.env.WORKER_BASE_URL}/api/webhooks/twilio/sms`,
        voiceUrl: `${c.env.WORKER_BASE_URL}/api/webhooks/twilio/voice`,
    });
    
    // Store in database
    await db.insert(companyPhoneNumbers).values({
        companyId,
        phoneNumber: purchased.phoneNumber,
        twilioSid: purchased.sid,
        friendlyName: purchased.friendlyName,
        isPrimary: true,
    });
    
    return c.json({ phoneNumber: purchased.phoneNumber });
});
```

---

## Acceptance Criteria

- [ ] Search returns available numbers
- [ ] Purchase creates number in Twilio
- [ ] Webhooks configured correctly
- [ ] Number stored in company_phone_numbers
- [ ] Audit log entry created

---

## Definition of Done

- [ ] Code reviewed
- [ ] Twilio integration tested
- [ ] PR merged
