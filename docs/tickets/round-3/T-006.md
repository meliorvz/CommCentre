# T-006: Migrate Templates Routes to DB

| Field | Value |
|-------|-------|
| **Status** | ðŸ”´ BLOCKED |
| **Round** | 3 |
| **Blocked By** | T-001 âœ…, T-004 âœ… |
| **Effort** | 4-6 hours |
| **Assignee** | _____________ |

---

## Background

Message templates (T-3, T-1, Day-of) are currently stored in KV with global keys. Migrate to per-company `company_templates` table.

---

## Current State

```typescript
// KV: templates:sms:T_MINUS_3, templates:email:DAY_OF, etc.
const template = await env.KV.get('templates:sms:T_MINUS_3');
```

---

## Target State

```typescript
const template = await db.select()
    .from(companyTemplates)
    .where(and(
        eq(companyTemplates.companyId, companyId),
        eq(companyTemplates.channel, 'sms'),
        eq(companyTemplates.ruleKey, 'T_MINUS_3')
    ))
    .limit(1);
```

---

## Files to Modify

- `src/worker/routes/templates.ts`
- `src/do/SchedulerDO.ts` (for sending scheduled messages)

---

## Acceptance Criteria

- [ ] GET /api/templates reads from DB
- [ ] PUT /api/templates/:channel/:rule writes to DB
- [ ] SchedulerDO uses per-company templates
- [ ] Default templates created for new companies

---

## Definition of Done

- [ ] Code reviewed
- [ ] Template UI works
- [ ] Scheduled messages use correct templates
- [ ] PR merged
