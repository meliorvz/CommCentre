# T-030: Gmail OAuth Backend

| Field | Value |
|-------|-------|
| **Status** | ðŸ”´ BLOCKED |
| **Round** | 3 |
| **Blocked By** | T-024 âœ… |
| **Effort** | 3-4 hours |
| **Assignee** | _____________ |

---

## Background

Backend API endpoints for Gmail OAuth flow.

---

## Implementation

```typescript
// GET /api/oauth/gmail/authorize
app.get('/api/oauth/gmail/authorize', authMiddleware, async (c) => {
    const companyId = c.get('companyId');
    const userId = c.get('user').id;
    
    // Create state token
    const state = await createOAuthState(c.env, { companyId, userId });
    
    const authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
    authUrl.searchParams.set('client_id', c.env.GOOGLE_CLIENT_ID);
    authUrl.searchParams.set('redirect_uri', `${c.env.WORKER_BASE_URL}/api/oauth/gmail/callback`);
    authUrl.searchParams.set('response_type', 'code');
    authUrl.searchParams.set('scope', 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/gmail.send');
    authUrl.searchParams.set('access_type', 'offline');
    authUrl.searchParams.set('prompt', 'consent');
    authUrl.searchParams.set('state', state);
    
    return c.redirect(authUrl.toString());
});

// GET /api/oauth/gmail/callback
app.get('/api/oauth/gmail/callback', async (c) => {
    // Implementation from T-024
    // Exchange code for tokens, store encrypted, redirect
});

// GET /api/gmail/status
app.get('/api/gmail/status', authMiddleware, async (c) => {
    const integration = await getIntegration(c.env, c.get('companyId'), 'gmail');
    return c.json({
        connected: !!integration,
        email: integration?.accountIdentifier,
    });
});
```

---

## Acceptance Criteria

- [ ] Authorize endpoint redirects to Google
- [ ] Callback exchanges code for tokens
- [ ] Tokens stored encrypted (T-023)
- [ ] Status endpoint works
- [ ] Error handling for failed OAuth

---

## Definition of Done

- [ ] Code reviewed
- [ ] OAuth flow tested
- [ ] PR merged
