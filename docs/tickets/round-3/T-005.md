# T-005: Migrate Settings Routes to DB

| Field | Value |
|-------|-------|
| **Status** | ðŸ”´ BLOCKED |
| **Round** | 3 |
| **Blocked By** | T-001 âœ…, T-003 âœ…, T-004 âœ… |
| **Effort** | 8-10 hours |
| **Assignee** | _____________ |

---

## Background

After T-001 creates the tenant-scoped tables and T-003/T-004 set up ConfigDO and DB context, we need to **update the settings routes** to read/write from the database instead of Cloudflare KV.

---

## Current State

```typescript
// CURRENT: Uses KV with global keys
app.get('/api/settings', async (c) => {
    const settings = await c.env.KV.get('settings:global', 'json');
    return c.json(settings);
});

app.put('/api/settings', async (c) => {
    const settings = await c.req.json();
    await c.env.KV.put('settings:global', JSON.stringify(settings));
    return c.json({ success: true });
});
```

---

## Target State

```typescript
// NEW: Uses per-company DB tables
app.get('/api/settings', authMiddleware, async (c) => {
    const companyId = c.get('companyId');
    const db = getDb(c.env);
    
    const [profile] = await db.select().from(companyProfile)
        .where(eq(companyProfile.companyId, companyId));
    
    const [aiConfig] = await db.select().from(companyAiConfig)
        .where(eq(companyAiConfig.companyId, companyId));
    
    return c.json({
        profile: profile || getDefaultProfile(),
        aiConfig: aiConfig || getDefaultAiConfig(),
    });
});

app.put('/api/settings/profile', authMiddleware, async (c) => {
    const companyId = c.get('companyId');
    const updates = await c.req.json();
    const db = getDb(c.env);
    
    await db.insert(companyProfile)
        .values({ companyId, ...updates })
        .onConflictDoUpdate({
            target: companyProfile.companyId,
            set: { ...updates, updatedAt: new Date() },
        });
    
    // Invalidate ConfigDO cache
    await invalidateConfig(c.env, companyId);
    
    // Audit log
    await logAudit(c.env, { ... });
    
    return c.json({ success: true });
});
```

---

## Files to Modify

1. `src/worker/routes/settings.ts` - All CRUD operations
2. `src/do/ConfigDO.ts` - Reload endpoint
3. Remove KV calls for settings

---

## Acceptance Criteria

- [ ] GET /api/settings reads from DB
- [ ] PUT /api/settings/* writes to DB
- [ ] ConfigDO cache invalidated on update
- [ ] Audit logging on all changes
- [ ] KV fallback during migration (optional)
- [ ] All existing settings routes working

---

## Definition of Done

- [ ] Code reviewed
- [ ] Settings UI still works
- [ ] Integration tests passing
- [ ] PR merged
