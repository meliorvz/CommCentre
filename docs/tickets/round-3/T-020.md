# T-020: Implement Pre-Send Credit Checks

| Field | Value |
|-------|-------|
| **Status** | ðŸ”´ BLOCKED |
| **Round** | 3 |
| **Blocked By** | T-003 âœ… |
| **Effort** | 4-6 hours |
| **Assignee** | _____________ |

---

## Background

Currently, messages are sent and credits deducted afterward. If a company has exhausted their credits, they're still charged and go into negative balance. We need to check credits BEFORE sending.

---

## Implementation

```typescript
// src/worker/lib/twilio.ts

export async function sendSms(env: Env, params: SendSmsParams): Promise<TwilioMessage> {
    const { companyId, to, body, preferredFrom } = params;
    
    // Check credits BEFORE sending
    const hasCredits = await checkCredits(env, companyId, CREDIT_COSTS.sms_outbound);
    
    if (!hasCredits) {
        // Log the blocked send
        await logCommsEvent(env, {
            companyId,
            channel: 'sms',
            direction: 'outbound',
            status: 'blocked',
            errorMessage: 'Insufficient credits',
            toAddr: to,
        });
        
        // Escalate to owner
        await escalateCreditExhaustion(env, companyId);
        
        throw new InsufficientCreditsError(companyId);
    }
    
    // Proceed with send...
    const result = await twilioClient.messages.create({...});
    
    // Deduct credits on success
    await deductCredits(env, companyId, CREDIT_COSTS.sms_outbound);
    
    return result;
}
```

---

## Acceptance Criteria

- [ ] Credits checked before SMS send
- [ ] Credits checked before email send
- [ ] Credits checked before LLM call
- [ ] Insufficient credits blocks send
- [ ] Escalation sent on credit exhaustion
- [ ] Clear error message returned

---

## Definition of Done

- [ ] Code reviewed
- [ ] Integration tests for credit exhaustion
- [ ] Escalation flow tested
- [ ] PR merged
