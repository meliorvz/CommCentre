# T-040: Google Sign-In Authentication

| Field | Value |
|-------|-------|
| **Status** | ðŸ”´ BLOCKED |
| **Round** | 3 |
| **Blocked By** | All P0 Security Tickets |
| **Effort** | 4-5 hours |
| **Assignee** | _____________ |

---

## Background

Add Google Sign-In as an authentication option alongside email/password.

---

## Implementation

### Frontend

```tsx
// Login page
function LoginPage() {
    return (
        <div>
            <form onSubmit={handleEmailLogin}>
                <Input name="email" />
                <Input name="password" type="password" />
                <Button>Sign In</Button>
            </form>
            
            <Divider>or</Divider>
            
            <Button onClick={() => window.location.href = '/api/auth/google'}>
                <GoogleIcon /> Sign in with Google
            </Button>
        </div>
    );
}
```

### Backend

```typescript
// GET /api/auth/google
app.get('/api/auth/google', async (c) => {
    const authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
    authUrl.searchParams.set('client_id', c.env.GOOGLE_CLIENT_ID);
    authUrl.searchParams.set('redirect_uri', `${c.env.WORKER_BASE_URL}/api/auth/google/callback`);
    authUrl.searchParams.set('response_type', 'code');
    authUrl.searchParams.set('scope', 'email profile');
    authUrl.searchParams.set('state', await createState(c.env));
    
    return c.redirect(authUrl.toString());
});

// GET /api/auth/google/callback
app.get('/api/auth/google/callback', async (c) => {
    const code = c.req.query('code');
    
    // Exchange code for tokens
    const tokenRes = await fetch('https://oauth2.googleapis.com/token', {
        method: 'POST',
        body: new URLSearchParams({
            code,
            client_id: c.env.GOOGLE_CLIENT_ID,
            client_secret: c.env.GOOGLE_CLIENT_SECRET,
            redirect_uri: `${c.env.WORKER_BASE_URL}/api/auth/google/callback`,
            grant_type: 'authorization_code',
        }),
    });
    const tokens = await tokenRes.json();
    
    // Get user info
    const userRes = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { Authorization: `Bearer ${tokens.access_token}` },
    });
    const googleUser = await userRes.json();
    
    // Find or create user
    let [user] = await db.select().from(users)
        .where(eq(users.email, googleUser.email));
    
    if (!user) {
        // Create new user
        [user] = await db.insert(users).values({
            email: googleUser.email,
            name: googleUser.name,
            googleId: googleUser.id,
        }).returning();
    }
    
    // Create session
    const jwt = await signJwt({ userId: user.id, ... }, c.env.JWT_SECRET);
    setCookie(c, 'auth_token', jwt, { ... });
    
    return c.redirect('/dashboard');
});
```

---

## Acceptance Criteria

- [ ] Google Sign-In button on login page
- [ ] OAuth flow completes successfully
- [ ] New users created on first sign-in
- [ ] Existing users linked by email
- [ ] Session created upon success

---

## Definition of Done

- [ ] Code reviewed
- [ ] OAuth flow tested
- [ ] PR merged
