# T-039: Style Learning Feature

| Field | Value |
|-------|-------|
| **Status** | âœ… DONE |
| **Round** | 3 |
| **Blocked By** | T-029 âœ…, T-030 âœ… |
| **Effort** | 8-10 hours |
| **Assignee** | Agent |

---

## Background

Learn the company's communication style by analyzing their sent emails and using it to personalize AI responses.

---

## Implementation Flow

1. **Fetch sent emails** via Gmail API
2. **Analyze with LLM** to extract style patterns
3. **Generate style prompt** for AI
4. **Store as company style guide**

```typescript
// POST /api/style/learn
app.post('/api/style/learn', authMiddleware, async (c) => {
    const companyId = c.get('companyId');
    const gmail = await getGmailClient(c.env, companyId);

    // Fetch recent sent emails
    const messages = await gmail.users.messages.list({
        userId: 'me',
        labelIds: ['SENT'],
        maxResults: 50,
    });

    // Get full message bodies
    const emails = await Promise.all(
        messages.data.messages.map(m =>
            gmail.users.messages.get({ userId: 'me', id: m.id })
        )
    );

    // Extract text content
    const emailTexts = emails.map(e => extractBody(e.data));

    // Analyze with LLM
    const styleAnalysis = await analyzeStyle(c.env, emailTexts);

    // Store as prompt addition
    await db.update(companyProfile)
        .set({ styleGuide: styleAnalysis.stylePrompt })
        .where(eq(companyProfile.companyId, companyId));

    return c.json({
        traits: styleAnalysis.traits,
        examplePhrases: styleAnalysis.examplePhrases,
    });
});
```

---

## LLM Analysis Prompt

```
Analyze these 50 sent emails and extract the communication style:

1. Tone (formal/casual/friendly)
2. Common greeting patterns
3. Common sign-off patterns
4. Vocabulary preferences
5. Sentence structure tendencies
6. Unique phrases or expressions

Output a <style_guide> that can be injected into an AI prompt.
```

---

## Acceptance Criteria

- [x] Fetches sent emails from Gmail
- [x] Analyzes with LLM
- [x] Extracts meaningful style traits
- [x] Stores as reusable prompt
- [x] Shows learned traits to user

---

## Definition of Done

- [x] Code reviewed
- [ ] Style analysis tested
- [ ] AI responses reflect learned style
- [ ] PR merged

---

## âœ… Implementation Complete (2026-01-06)

**Files Created:**
- `src/worker/lib/style-analyzer.ts` - Email fetching and LLM analysis
- `src/worker/routes/style.ts` - API routes for style management
- `src/db/migrations/0005_style_guide.sql` - Database migration

**Files Modified:**
- `src/db/schema.ts` - Added `styleGuide` and `styleGuideUpdatedAt` columns to `company_profile`
- `src/worker/index.ts` - Mounted style routes at `/api/style`
- `src/do/ThreadDO.ts` - Injects style guide into AI system prompt

**API Endpoints:**
- `POST /api/style/learn` - Fetch sent emails, analyze with LLM, store style guide
- `GET /api/style/current` - Get current style guide
- `PUT /api/style/update` - Manually update style guide
- `DELETE /api/style` - Clear style guide

**Next Steps:**
1. Run database migration: `src/db/migrations/0005_style_guide.sql`
2. Deploy to dev: `npm run deploy:dev`
3. Connect Gmail for a company
4. Test style learning: `POST /api/style/learn`
5. Send a test message and verify AI responses use learned style
6. Create PR and merge

---

## ðŸš€ Developer Pickup Instructions

> **Estimated Time**: 8-10 hours | **Complexity**: High
> **Note**: Depends on T-029 âœ… and T-030 âœ… (Gmail OAuth complete)

### Prerequisites
- T-029 and T-030 complete (Gmail OAuth working)
- Google Cloud project with Gmail API enabled

### Step-by-Step Implementation

```bash
# 1. Start from project root
cd /Users/victor/Documents/CommsCentre

# 2. Review existing Gmail integration
cat src/worker/lib/gmail.ts
```

**Step 1: Add style guide column to schema**
```typescript
// In src/db/schema.ts, add to company_profile:
styleGuide: text('style_guide'),
```

**Step 2: Create `src/worker/routes/style.ts`**
```typescript
// POST /api/style/learn - Fetch and analyze emails
// GET /api/style/profile - Return current style guide
```

**Step 3: Create `src/worker/lib/style-analyzer.ts`**
```typescript
export async function analyzeStyle(env: Env, emails: string[]): Promise<StyleAnalysis> {
    // Call LLM with analysis prompt
    // Return { stylePrompt, traits, examplePhrases }
}
```

**Step 4: Update ThreadDO to inject style**
In `src/do/ThreadDO.ts`, include `styleGuide` in AI system prompt

### LLM Analysis Prompt Example
```
Analyze these sent emails and extract:
1. Tone (formal/casual/friendly)
2. Common greeting patterns
3. Sign-off patterns
4. Vocabulary preferences
5. Unique phrases

Output a <style_guide> for AI to mimic.
```

### Verification Commands

```bash
# 1. Type check
npm run typecheck

# 2. Deploy
npm run deploy:dev

# 3. Test flow:
# - Connect Gmail
# - Call POST /api/style/learn
# - Verify style traits extracted
# - Send test message, verify AI uses learned style
```

### When Complete
1. Update this ticket status to âœ… DONE
2. Update `docs/TICKET_DASHBOARD.md`
3. Create PR: `feat(ai): T-039 style learning from emails`
