# T-010: Implement Telegram Webhook Security

| Field | Value |
|-------|-------|
| **Status** | ðŸŸ¡ READY |
| **Round** | 1 (No Dependencies) |
| **Effort** | 2-3 hours |
| **Assignee** | _____________ |

---

## Background

This platform has a **Telegram bot** (`@ParadiseCommsBot`) that receives messages via webhooks. When a user sends a message to the bot, Telegram POSTs to our webhook URL.

Currently, **anyone who discovers the webhook URL can send fake messages**. While Telegram's webhook system is more obscure than Twilio's, it's still a security gap.

---

## Current State (Problem)

```typescript
// src/worker/routes/webhooks/telegram.ts

// NO VALIDATION - anyone can POST fake updates
app.post('/api/webhooks/telegram', async (c) => {
    const update = await c.req.json();
    // Processes the update as if it came from Telegram...
});
```

---

## What This Ticket Achieves

Telegram supports a **secret token** that gets sent in the `X-Telegram-Bot-Api-Secret-Token` header. We'll:

1. Set the secret token when registering the webhook
2. Validate the header on every incoming request

---

## Implementation

### Step 1: Update Webhook Registration

When registering the webhook with Telegram, include the secret token:

```bash
# Current registration (NOT SECURE)
curl "https://api.telegram.org/bot$BOT_TOKEN/setWebhook?url=https://your-worker.workers.dev/api/webhooks/telegram"

# New registration (WITH SECRET)
curl "https://api.telegram.org/bot$BOT_TOKEN/setWebhook?url=https://your-worker.workers.dev/api/webhooks/telegram&secret_token=YOUR_SECRET_TOKEN"
```

### Step 2: Validate in Worker

**`src/worker/routes/webhooks/telegram.ts`**

```typescript
app.post('/api/webhooks/telegram', async (c) => {
    // Check the secret token header
    const secretToken = c.req.header('X-Telegram-Bot-Api-Secret-Token');
    
    if (secretToken !== c.env.TELEGRAM_WEBHOOK_SECRET) {
        console.warn('Invalid Telegram webhook secret');
        return c.text('Forbidden', 403);
    }
    
    // Valid request - process the update
    const update = await c.req.json();
    // ... existing handler logic
});
```

### Step 3: Add Environment Variable

```bash
# Add to wrangler secrets
npx wrangler secret put TELEGRAM_WEBHOOK_SECRET
# Use a random 32+ character string

# Also add to wrangler.toml for local dev
[vars]
TELEGRAM_WEBHOOK_SECRET = "your-dev-secret"
```

### Step 4: Re-register Webhook

Create or update a script to register the webhook with the secret:

**`scripts/register-telegram-webhook.mjs`**

```javascript
#!/usr/bin/env node

const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const WEBHOOK_URL = process.env.WORKER_BASE_URL + '/api/webhooks/telegram';
const SECRET_TOKEN = process.env.TELEGRAM_WEBHOOK_SECRET;

const response = await fetch(
    `https://api.telegram.org/bot${BOT_TOKEN}/setWebhook`,
    {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            url: WEBHOOK_URL,
            secret_token: SECRET_TOKEN
        })
    }
);

const result = await response.json();
console.log('Webhook registration:', result);
```

---

## Acceptance Criteria

- [ ] Webhook validates `X-Telegram-Bot-Api-Secret-Token` header
- [ ] Invalid/missing token returns 403
- [ ] Valid token proceeds to handler
- [ ] Webhook registration script updated to set secret_token
- [ ] Production webhook re-registered with new secret

---

## How to Test

```bash
# Test without secret header - should fail
curl -X POST https://your-worker.workers.dev/api/webhooks/telegram \
  -H "Content-Type: application/json" \
  -d '{"update_id":123,"message":{"text":"test"}}'
# Expected: 403 Forbidden

# Test with wrong secret - should fail
curl -X POST https://your-worker.workers.dev/api/webhooks/telegram \
  -H "Content-Type: application/json" \
  -H "X-Telegram-Bot-Api-Secret-Token: wrong" \
  -d '{"update_id":123,"message":{"text":"test"}}'
# Expected: 403 Forbidden

# Test with correct secret - should succeed
curl -X POST https://your-worker.workers.dev/api/webhooks/telegram \
  -H "Content-Type: application/json" \
  -H "X-Telegram-Bot-Api-Secret-Token: YOUR_ACTUAL_SECRET" \
  -d '{"update_id":123,"message":{"text":"test"}}'
# Expected: 200 OK
```

---

## Definition of Done

- [ ] Code reviewed
- [ ] Secret configured in development and production
- [ ] Webhook re-registered with secret_token
- [ ] Invalid request test (403)
- [ ] Valid Telegram request works
- [ ] PR merged to main
