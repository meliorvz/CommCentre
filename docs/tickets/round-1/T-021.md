# T-021: Add Usage Events Ledger

| Field | Value |
|-------|-------|
| **Status** | ðŸŸ¡ READY |
| **Round** | 1 (No Dependencies) |
| **Effort** | 4-6 hours |
| **Assignee** | _____________ |

---

## Background

This platform uses a **credit-based billing system**. Companies buy credits, and credits are consumed when they send SMS, emails, or make AI calls. Currently, credit deductions are done directly on the `companies.credit_balance` field, but there's **no detailed ledger** of what consumed credits.

This makes it impossible to:
- Show customers what they're being charged for
- Debug billing disputes
- Generate usage reports
- Audit billing accuracy

---

## What This Ticket Achieves

Create a `usage_events` table that logs every billable action with full details. This becomes the source of truth for:
- Usage-based billing
- Customer invoices
- Usage analytics
- Audit trail

---

## Database Table

```sql
CREATE TABLE usage_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    event_type TEXT NOT NULL CHECK (event_type IN ('sms_outbound', 'sms_inbound', 'email_outbound', 'llm_call', 'call_forwarded')),
    units INTEGER NOT NULL DEFAULT 1,
    cost_credits INTEGER NOT NULL,
    external_id TEXT, -- Provider message ID, for correlation
    description TEXT, -- Human-readable description
    metadata JSONB DEFAULT '{}', -- Additional context
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_usage_events_company ON usage_events(company_id, created_at DESC);
CREATE INDEX idx_usage_events_type ON usage_events(company_id, event_type);
```

---

## Implementation

### Create Usage Logger

**`src/worker/lib/usage.ts`**

```typescript
import { usageEvents } from '../db/schema';
import { getDb } from '../db';

type EventType = 'sms_outbound' | 'sms_inbound' | 'email_outbound' | 'llm_call' | 'call_forwarded';

interface UsageEventInput {
    companyId: string;
    eventType: EventType;
    units?: number;
    costCredits: number;
    externalId?: string;
    description?: string;
    metadata?: Record<string, unknown>;
}

export async function logUsage(env: Env, event: UsageEventInput) {
    const db = getDb(env);
    
    await db.insert(usageEvents).values({
        companyId: event.companyId,
        eventType: event.eventType,
        units: event.units ?? 1,
        costCredits: event.costCredits,
        externalId: event.externalId,
        description: event.description,
        metadata: event.metadata ?? {},
    });
}

// Credit costs (adjust based on your pricing)
export const CREDIT_COSTS = {
    sms_outbound: 1,
    sms_inbound: 0, // Free to receive
    email_outbound: 1,
    llm_call: 2,
    call_forwarded: 5,
};
```

---

## Files to Modify

### `src/worker/lib/twilio.ts`

Log usage when sending SMS:

```typescript
import { logUsage, CREDIT_COSTS } from './usage';

export async function sendSms(env: Env, params: SmsParams) {
    const result = await twilioClient.messages.create({...});
    
    // Log usage
    await logUsage(env, {
        companyId: params.companyId,
        eventType: 'sms_outbound',
        costCredits: CREDIT_COSTS.sms_outbound,
        externalId: result.sid,
        description: `SMS to ${params.to}`,
    });
    
    return result;
}
```

### `src/worker/lib/gmail.ts`

Log usage when sending email:

```typescript
import { logUsage, CREDIT_COSTS } from './usage';

export async function sendEmail(env: Env, params: EmailParams) {
    const result = await gmail.send({...});
    
    await logUsage(env, {
        companyId: params.companyId,
        eventType: 'email_outbound',
        costCredits: CREDIT_COSTS.email_outbound,
        externalId: result.id,
        description: `Email to ${params.to}: ${params.subject}`,
    });
    
    return result;
}
```

### `src/do/ThreadDO.ts` (LLM calls)

Log usage when making AI calls:

```typescript
import { logUsage, CREDIT_COSTS } from '../lib/usage';

async function callLLM(prompt: string, companyId: string) {
    const response = await openrouter.chat({...});
    
    await logUsage(this.env, {
        companyId,
        eventType: 'llm_call',
        costCredits: CREDIT_COSTS.llm_call,
        description: 'AI response generation',
        metadata: {
            model: response.model,
            tokens: response.usage?.total_tokens,
        },
    });
    
    return response;
}
```

---

## Usage Reporting Query

```sql
-- Monthly usage summary by type
SELECT 
    event_type,
    COUNT(*) as count,
    SUM(cost_credits) as total_credits
FROM usage_events
WHERE company_id = 'xxx'
  AND created_at >= date_trunc('month', NOW())
GROUP BY event_type;

-- Daily usage for charts
SELECT 
    DATE(created_at) as date,
    SUM(cost_credits) as credits_used
FROM usage_events
WHERE company_id = 'xxx'
  AND created_at >= NOW() - INTERVAL '30 days'
GROUP BY DATE(created_at)
ORDER BY date;
```

---

## Acceptance Criteria

- [ ] `usage_events` table created
- [ ] All billable events logged (SMS, email, LLM, calls)
- [ ] Each event includes cost_credits
- [ ] Events queryable by company and date range
- [ ] External IDs populated for correlation

---

## How to Test

1. Send an SMS via the platform
2. Query usage_events:
   ```sql
   SELECT * FROM usage_events WHERE company_id = 'xxx' ORDER BY created_at DESC LIMIT 5;
   ```
3. Verify SMS event logged with correct cost

---

## Definition of Done

- [ ] Code reviewed
- [ ] Usage logging added to all billable paths
- [ ] Manual tests passing
- [ ] PR merged to main
