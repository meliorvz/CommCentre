# T-026: Implement Audit Logging

| Field | Value |
|-------|-------|
| **Status** | ðŸŸ¡ READY |
| **Round** | 1 (No Dependencies) |
| **Effort** | 6-8 hours |
| **Assignee** | _____________ |

---

## Background

For security and compliance, we need to track **who did what and when**. Currently, there's no audit trail for administrative actions like:

- User account changes
- Settings modifications
- Subscription changes
- Integration connections/disconnections

This makes security investigations and compliance reporting very difficult.

---

## What This Ticket Achieves

Implement comprehensive audit logging for all sensitive administrative actions. The audit log will capture:

- **Who** (user ID, email, IP address)
- **What** (action type, resource affected)
- **When** (timestamp)
- **Details** (before/after values where applicable)

---

## Database Table

The schema already has an `audit_log` table, but verify it exists or create:

```sql
CREATE TABLE IF NOT EXISTS audit_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID REFERENCES companies(id) ON DELETE SET NULL,
    actor_user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    actor_email TEXT,
    actor_ip TEXT,
    action TEXT NOT NULL,
    resource_type TEXT NOT NULL,
    resource_id TEXT,
    before_state JSONB,
    after_state JSONB,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_audit_log_company ON audit_log(company_id, created_at DESC);
CREATE INDEX idx_audit_log_actor ON audit_log(actor_user_id, created_at DESC);
CREATE INDEX idx_audit_log_action ON audit_log(action, created_at DESC);
```

---

## Implementation

### Audit Logger Module

**`src/worker/lib/audit.ts`**

```typescript
import { auditLog } from '../db/schema';
import { getDb } from '../db';

export type AuditAction = 
    | 'user.created'
    | 'user.updated'
    | 'user.deleted'
    | 'user.login'
    | 'user.login_failed'
    | 'settings.updated'
    | 'prompt.updated'
    | 'prompt.published'
    | 'knowledge.updated'
    | 'template.updated'
    | 'subscription.created'
    | 'subscription.updated'
    | 'subscription.cancelled'
    | 'integration.connected'
    | 'integration.disconnected'
    | 'phone.provisioned'
    | 'phone.released';

export type ResourceType =
    | 'user'
    | 'company'
    | 'settings'
    | 'prompt'
    | 'knowledge_item'
    | 'template'
    | 'subscription'
    | 'integration'
    | 'phone_number';

interface AuditLogEntry {
    companyId?: string;
    actorUserId?: string;
    actorEmail?: string;
    actorIp?: string;
    action: AuditAction;
    resourceType: ResourceType;
    resourceId?: string;
    beforeState?: Record<string, unknown>;
    afterState?: Record<string, unknown>;
    metadata?: Record<string, unknown>;
}

export async function logAudit(env: Env, entry: AuditLogEntry) {
    const db = getDb(env);
    
    await db.insert(auditLog).values({
        companyId: entry.companyId,
        actorUserId: entry.actorUserId,
        actorEmail: entry.actorEmail,
        actorIp: entry.actorIp,
        action: entry.action,
        resourceType: entry.resourceType,
        resourceId: entry.resourceId,
        beforeState: entry.beforeState,
        afterState: entry.afterState,
        metadata: entry.metadata ?? {},
    });
}

/**
 * Helper to get audit context from request
 */
export function getAuditContext(c: Context): Pick<AuditLogEntry, 'actorUserId' | 'actorEmail' | 'actorIp' | 'companyId'> {
    const user = c.get('user');
    
    return {
        actorUserId: user?.id,
        actorEmail: user?.email,
        actorIp: c.req.header('CF-Connecting-IP') || c.req.header('X-Forwarded-For'),
        companyId: user?.companyId || c.get('companyId'),
    };
}
```

---

## Files to Modify

### `src/worker/routes/auth.ts`

Log login events:

```typescript
import { logAudit, getAuditContext } from '../lib/audit';

app.post('/api/auth/login', async (c) => {
    const { email, password } = await c.req.json();
    
    const [user] = await db.select().from(users).where(eq(users.email, email));
    
    if (!user || !await verifyPassword(password, user.passwordHash)) {
        // Log failed login
        await logAudit(c.env, {
            actorEmail: email,
            actorIp: c.req.header('CF-Connecting-IP'),
            action: 'user.login_failed',
            resourceType: 'user',
            metadata: { reason: 'invalid_credentials' },
        });
        return c.json({ error: 'Invalid credentials' }, 401);
    }
    
    // Log successful login
    await logAudit(c.env, {
        companyId: user.companyId,
        actorUserId: user.id,
        actorEmail: user.email,
        actorIp: c.req.header('CF-Connecting-IP'),
        action: 'user.login',
        resourceType: 'user',
        resourceId: user.id,
    });
    
    // ... generate token and return
});
```

### `src/worker/routes/settings.ts`

Log settings changes:

```typescript
import { logAudit, getAuditContext } from '../lib/audit';

app.put('/api/settings/:type', async (c) => {
    const type = c.req.param('type');
    const newSettings = await c.req.json();
    const auditCtx = getAuditContext(c);
    
    // Get current settings for before state
    const currentSettings = await getCurrentSettings(c.env, auditCtx.companyId);
    
    // Update settings
    await updateSettings(c.env, auditCtx.companyId, newSettings);
    
    // Log the change
    await logAudit(c.env, {
        ...auditCtx,
        action: 'settings.updated',
        resourceType: 'settings',
        resourceId: type,
        beforeState: currentSettings,
        afterState: newSettings,
    });
    
    return c.json({ success: true });
});
```

### `src/worker/routes/users.ts`

Log user management:

```typescript
app.post('/api/users', async (c) => {
    const userData = await c.req.json();
    const auditCtx = getAuditContext(c);
    
    const [newUser] = await db.insert(users).values({...}).returning();
    
    await logAudit(c.env, {
        ...auditCtx,
        action: 'user.created',
        resourceType: 'user',
        resourceId: newUser.id,
        afterState: { email: newUser.email, role: newUser.role },
    });
    
    return c.json(newUser);
});

app.delete('/api/users/:id', async (c) => {
    const userId = c.req.param('id');
    const auditCtx = getAuditContext(c);
    
    const [deletedUser] = await db.delete(users).where(eq(users.id, userId)).returning();
    
    await logAudit(c.env, {
        ...auditCtx,
        action: 'user.deleted',
        resourceType: 'user',
        resourceId: userId,
        beforeState: { email: deletedUser.email },
    });
    
    return c.json({ success: true });
});
```

---

## Events to Log

| Route | Action | Resource |
|-------|--------|----------|
| POST /api/auth/login | user.login / user.login_failed | user |
| POST /api/users | user.created | user |
| PUT /api/users/:id | user.updated | user |
| DELETE /api/users/:id | user.deleted | user |
| PUT /api/settings/* | settings.updated | settings |
| POST /api/prompts/publish | prompt.published | prompt |
| PUT /api/prompts/:id | prompt.updated | prompt |
| POST /api/knowledge/* | knowledge.updated | knowledge_item |
| POST /api/subscriptions | subscription.created | subscription |
| DELETE /api/subscriptions | subscription.cancelled | subscription |
| POST /api/integrations/:type | integration.connected | integration |
| DELETE /api/integrations/:type | integration.disconnected | integration |

---

## Acceptance Criteria

- [ ] `audit_log` table exists with proper schema
- [ ] Audit logger module created
- [ ] Login events logged (success and failure)
- [ ] User CRUD logged
- [ ] Settings changes logged with before/after
- [ ] Queryable by company, actor, date

---

## How to Query Audit Log

```sql
-- Recent activity for a company
SELECT action, actor_email, resource_type, created_at
FROM audit_log
WHERE company_id = 'xxx'
ORDER BY created_at DESC
LIMIT 50;

-- Failed login attempts
SELECT actor_email, actor_ip, created_at
FROM audit_log
WHERE action = 'user.login_failed'
  AND created_at > NOW() - INTERVAL '24 hours'
ORDER BY created_at DESC;

-- Changes by a specific user
SELECT action, resource_type, before_state, after_state, created_at
FROM audit_log
WHERE actor_user_id = 'xxx'
ORDER BY created_at DESC;
```

---

## Definition of Done

- [ ] Code reviewed
- [ ] Audit logging added to all sensitive routes
- [ ] Before/after states captured where applicable
- [ ] Manual tests passing
- [ ] PR merged to main
