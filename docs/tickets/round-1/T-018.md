# T-018: Implement Argon2id Password Hashing

| Field | Value |
|-------|-------|
| **Status** | ðŸŸ¡ READY |
| **Round** | 1 (No Dependencies) |
| **Effort** | 4-6 hours |
| **Assignee** | _____________ |

---

## Background

This platform currently uses **SHA-256 for password hashing**. SHA-256 is a general-purpose hash, NOT a password hash. It's:

- **Too fast** - GPUs can compute billions of SHA-256 hashes per second
- **No salt** (depends on implementation)
- **No memory hardness** - easily parallelized on specialized hardware

A security reviewer flagged this as **P0**: *"SHA-256 password hashes with modern hardware can be brute-forced at 10+ billion attempts per second."*

---

## Current State (Problem)

```typescript
// src/worker/routes/auth.ts

import { createHash } from 'crypto';

function hashPassword(password: string): string {
    return createHash('sha256').update(password).digest('hex');
}

async function verifyPassword(password: string, hash: string): Promise<boolean> {
    return hashPassword(password) === hash;
}
```

This produces a 64-character hex hash that's trivially brute-forceable.

---

## What This Ticket Achieves

Replace SHA-256 with **Argon2id**, the winner of the Password Hashing Competition. Argon2id is:

- Memory-hard (resistant to GPU/ASIC attacks)
- Time-configurable (we can tune how long hashing takes)
- Salted by default
- The recommended algorithm for password storage

We'll also implement **backward compatibility** - existing users with SHA-256 hashes can still log in, and their passwords will be migrated to Argon2id on successful login.

---

## Implementation

### Install Dependency

```bash
npm install @node-rs/argon2
```

> Note: `@node-rs/argon2` is a native Rust binding that works in Cloudflare Workers.

### Create Password Module

**`src/worker/lib/password.ts`**

```typescript
import { hash, verify } from '@node-rs/argon2';

// Argon2id parameters (adjust for your security/performance needs)
const ARGON2_OPTIONS = {
    memoryCost: 65536,    // 64 MB
    timeCost: 3,          // 3 iterations
    parallelism: 1,       // 1 thread (Workers are single-threaded)
};

/**
 * Hash a password using Argon2id
 */
export async function hashPassword(password: string): Promise<string> {
    return hash(password, ARGON2_OPTIONS);
}

/**
 * Verify a password against a hash
 * Handles both Argon2id and legacy SHA-256 hashes
 */
export async function verifyPassword(
    password: string, 
    storedHash: string
): Promise<{ valid: boolean; needsRehash: boolean }> {
    // Detect hash type
    if (isLegacySha256Hash(storedHash)) {
        // Legacy SHA-256 verification
        const sha256Hash = crypto.subtle.digest(
            'SHA-256', 
            new TextEncoder().encode(password)
        );
        const hashHex = Array.from(new Uint8Array(await sha256Hash))
            .map(b => b.toString(16).padStart(2, '0'))
            .join('');
        
        return {
            valid: hashHex === storedHash,
            needsRehash: true, // Flag for migration
        };
    }
    
    // Argon2id verification
    try {
        const valid = await verify(storedHash, password);
        return { valid, needsRehash: false };
    } catch {
        return { valid: false, needsRehash: false };
    }
}

/**
 * Check if hash is legacy SHA-256 (64 hex chars)
 */
function isLegacySha256Hash(hash: string): boolean {
    return /^[a-f0-9]{64}$/i.test(hash);
}
```

---

## Files to Modify

### `src/worker/routes/auth.ts`

Update login to handle migration:

```typescript
import { hashPassword, verifyPassword } from '../lib/password';

app.post('/api/auth/login', async (c) => {
    const { email, password } = await c.req.json();
    
    // Find user
    const [user] = await db.select().from(users)
        .where(eq(users.email, email))
        .limit(1);
    
    if (!user) {
        return c.json({ error: 'Invalid credentials' }, 401);
    }
    
    // Verify password
    const { valid, needsRehash } = await verifyPassword(password, user.passwordHash);
    
    if (!valid) {
        return c.json({ error: 'Invalid credentials' }, 401);
    }
    
    // Migrate legacy hash if needed
    if (needsRehash) {
        const newHash = await hashPassword(password);
        await db.update(users)
            .set({ passwordHash: newHash })
            .where(eq(users.id, user.id));
        
        console.log(`Migrated password hash for user ${user.id}`);
    }
    
    // Generate JWT and return
    // ...
});
```

### `src/worker/routes/users.ts`

Update user creation:

```typescript
import { hashPassword } from '../lib/password';

app.post('/api/users', async (c) => {
    const { email, password, ... } = await c.req.json();
    
    const passwordHash = await hashPassword(password);
    
    await db.insert(users).values({
        email,
        passwordHash,
        // ...
    });
});
```

### `src/worker/routes/companies.ts`

Update company admin creation:

```typescript
import { hashPassword } from '../lib/password';

// When creating company with initial admin
const passwordHash = await hashPassword(generatedPassword);
```

---

## Acceptance Criteria

- [ ] `@node-rs/argon2` installed and working in Workers
- [ ] New user registrations use Argon2id
- [ ] Existing SHA-256 users can still log in
- [ ] SHA-256 hashes are migrated to Argon2id on successful login
- [ ] Password verification takes 100-500ms (not instant)
- [ ] All password-related routes updated

---

## How to Test

### Unit Test

```typescript
describe('password hashing', () => {
    it('hashes with Argon2id', async () => {
        const hash = await hashPassword('test123');
        expect(hash).toMatch(/^\$argon2id\$/);
    });
    
    it('verifies Argon2id hash', async () => {
        const hash = await hashPassword('test123');
        const { valid } = await verifyPassword('test123', hash);
        expect(valid).toBe(true);
    });
    
    it('verifies legacy SHA-256 hash', async () => {
        // Pre-computed SHA-256 of 'test123'
        const legacyHash = 'ecd71870d1963316a97e3ac3408c9835ad8cf0f3c1bc703527c30265534f75ae';
        const { valid, needsRehash } = await verifyPassword('test123', legacyHash);
        expect(valid).toBe(true);
        expect(needsRehash).toBe(true);
    });
});
```

### Manual Test

1. Create new user â†’ verify hash starts with `$argon2id$`
2. Login with old SHA-256 user â†’ verify login works and hash is updated
3. Check login time is ~200-500ms (not instant)

---

## Definition of Done

- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Manual migration test passing
- [ ] Performance verified (100-500ms per hash)
- [ ] PR merged to main
