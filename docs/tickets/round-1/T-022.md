# T-022: Add Entitlements Table

| Field | Value |
|-------|-------|
| **Status** | ðŸŸ¡ READY |
| **Round** | 1 (No Dependencies) |
| **Effort** | 3-4 hours |
| **Assignee** | _____________ |

---

## Background

Companies subscribe to **plans** (Starter, Professional, Scale) that include monthly credit allocations. Currently, the plan information is scattered across several fields in the `companies` table and `subscription_plans` table, but there's no unified place to track:

- How many credits are included in their plan
- When their allocation resets
- Whether they can go over their limit

---

## What This Ticket Achieves

Create an `entitlements` table that clearly tracks what each company is entitled to based on their subscription. This enables:

- Credit enforcement before sending
- Usage limit dashboards
- Overage calculations
- Plan limit enforcement

---

## Database Table

```sql
CREATE TABLE entitlements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE UNIQUE,
    plan_id UUID REFERENCES subscription_plans(id),
    
    -- Credits
    included_credits INTEGER NOT NULL DEFAULT 0,
    bonus_credits INTEGER NOT NULL DEFAULT 0, -- Promotional credits
    
    -- Reset schedule
    reset_at TIMESTAMPTZ NOT NULL,
    reset_frequency TEXT NOT NULL DEFAULT 'monthly' CHECK (reset_frequency IN ('monthly', 'annual')),
    
    -- Limits and policies
    overage_allowed BOOLEAN NOT NULL DEFAULT false,
    overage_rate_credits NUMERIC(10,2), -- Cost per overage unit
    
    -- Current period tracking
    period_start TIMESTAMPTZ NOT NULL,
    period_end TIMESTAMPTZ NOT NULL,
    credits_used_this_period INTEGER NOT NULL DEFAULT 0,
    
    -- Status
    status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'paused', 'cancelled')),
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_entitlements_company ON entitlements(company_id);
CREATE INDEX idx_entitlements_reset ON entitlements(reset_at) WHERE status = 'active';
```

---

## Implementation

### Create Entitlements Service

**`src/worker/lib/entitlements.ts`**

```typescript
import { entitlements, subscriptionPlans } from '../db/schema';
import { eq } from 'drizzle-orm';

export interface Entitlement {
    includedCredits: number;
    bonusCredits: number;
    creditsUsedThisPeriod: number;
    creditsRemaining: number;
    overageAllowed: boolean;
    periodEnd: Date;
    status: string;
}

export async function getEntitlements(env: Env, companyId: string): Promise<Entitlement | null> {
    const db = getDb(env);
    
    const [ent] = await db.select()
        .from(entitlements)
        .where(eq(entitlements.companyId, companyId))
        .limit(1);
    
    if (!ent) return null;
    
    const totalCredits = ent.includedCredits + ent.bonusCredits;
    const creditsRemaining = Math.max(0, totalCredits - ent.creditsUsedThisPeriod);
    
    return {
        includedCredits: ent.includedCredits,
        bonusCredits: ent.bonusCredits,
        creditsUsedThisPeriod: ent.creditsUsedThisPeriod,
        creditsRemaining,
        overageAllowed: ent.overageAllowed,
        periodEnd: ent.periodEnd,
        status: ent.status,
    };
}

export async function hasCredits(env: Env, companyId: string, required: number): Promise<boolean> {
    const ent = await getEntitlements(env, companyId);
    
    if (!ent || ent.status !== 'active') return false;
    
    if (ent.creditsRemaining >= required) return true;
    
    // Check if overage is allowed
    return ent.overageAllowed;
}

export async function consumeCredits(env: Env, companyId: string, amount: number): Promise<void> {
    const db = getDb(env);
    
    await db.update(entitlements)
        .set({ 
            creditsUsedThisPeriod: sql`credits_used_this_period + ${amount}`,
            updatedAt: new Date(),
        })
        .where(eq(entitlements.companyId, companyId));
}
```

---

## Stripe Webhook Integration

When a subscription is created/updated, populate the entitlements table:

**`src/worker/routes/webhooks/stripe.ts`**

```typescript
async function handleSubscriptionCreated(subscription: Stripe.Subscription) {
    const companyId = subscription.metadata.company_id;
    const priceId = subscription.items.data[0].price.id;
    
    // Look up plan by Stripe price ID
    const [plan] = await db.select()
        .from(subscriptionPlans)
        .where(eq(subscriptionPlans.stripePriceId, priceId))
        .limit(1);
    
    const periodStart = new Date(subscription.current_period_start * 1000);
    const periodEnd = new Date(subscription.current_period_end * 1000);
    
    await db.insert(entitlements).values({
        companyId,
        planId: plan.id,
        includedCredits: plan.monthlyCredits,
        resetAt: periodEnd,
        periodStart,
        periodEnd,
        overageAllowed: plan.overageAllowed ?? false,
    }).onConflictDoUpdate({
        target: entitlements.companyId,
        set: {
            planId: plan.id,
            includedCredits: plan.monthlyCredits,
            resetAt: periodEnd,
            periodStart,
            periodEnd,
            creditsUsedThisPeriod: 0, // Reset on new period
            updatedAt: new Date(),
        },
    });
}
```

---

## Acceptance Criteria

- [ ] `entitlements` table created
- [ ] Helper functions: `getEntitlements`, `hasCredits`, `consumeCredits`
- [ ] Populated when subscription is created
- [ ] Updated when subscription changes
- [ ] Credits usage tracked per period

---

## How to Test

```sql
-- Insert test entitlement
INSERT INTO entitlements (company_id, included_credits, period_start, period_end, reset_at)
VALUES ('xxx', 100, NOW(), NOW() + INTERVAL '1 month', NOW() + INTERVAL '1 month');

-- Check remaining credits
SELECT 
    included_credits + bonus_credits as total,
    credits_used_this_period as used,
    (included_credits + bonus_credits - credits_used_this_period) as remaining
FROM entitlements
WHERE company_id = 'xxx';
```

---

## Definition of Done

- [ ] Code reviewed
- [ ] Table and functions created
- [ ] Stripe integration added
- [ ] PR merged to main
