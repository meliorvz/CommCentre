# T-013: Implement Stripe Webhook Idempotency

| Field | Value |
|-------|-------|
| **Status** | ðŸŸ¡ READY |
| **Round** | 1 (No Dependencies) |
| **Effort** | 4-6 hours |
| **Assignee** | _____________ |

---

## Background

This platform uses **Stripe for billing** - subscriptions, credit purchases, etc. Stripe sends webhook events when payments succeed, subscriptions change, etc.

Stripe explicitly documents that they may **send the same event multiple times**. If we process duplicates, we could:
- Credit a company's account multiple times for the same payment
- Send duplicate confirmation emails
- Corrupt billing data

---

## Current State (Problem)

```typescript
// src/worker/routes/webhooks/stripe.ts

app.post('/api/webhooks/stripe', async (c) => {
    const event = await stripe.webhooks.constructEvent(...);
    
    switch (event.type) {
        case 'checkout.session.completed':
            // Credits the account - WILL HAPPEN MULTIPLE TIMES IF REPLAYED!
            await creditAccount(event.data.object);
            break;
        // ...
    }
});
```

There's no check if we've already processed this event.

---

## What This Ticket Achieves

Store processed Stripe event IDs in a `webhook_events` table. Before processing any event, check if it's already been handled.

---

## Implementation

### Database Table (from T-001, or create inline)

If T-001 isn't merged yet, you can add this table in your PR:

```sql
CREATE TABLE IF NOT EXISTS webhook_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    provider TEXT NOT NULL,
    event_id TEXT NOT NULL,
    event_type TEXT NOT NULL,
    processed_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(provider, event_id)
);
```

### Updated Handler

**`src/worker/routes/webhooks/stripe.ts`**

```typescript
import { webhookEvents } from '../db/schema';
import { eq, and } from 'drizzle-orm';

app.post('/api/webhooks/stripe', async (c) => {
    const sig = c.req.header('stripe-signature');
    const body = await c.req.text();
    
    let event: Stripe.Event;
    try {
        event = stripe.webhooks.constructEvent(body, sig!, c.env.STRIPE_WEBHOOK_SECRET);
    } catch (err) {
        console.error('Stripe webhook signature verification failed');
        return c.text('Invalid signature', 400);
    }
    
    // ========= IDEMPOTENCY CHECK =========
    const db = getDb(c.env);
    
    // Check if we've already processed this event
    const [existing] = await db.select()
        .from(webhookEvents)
        .where(and(
            eq(webhookEvents.provider, 'stripe'),
            eq(webhookEvents.eventId, event.id)
        ))
        .limit(1);
    
    if (existing) {
        console.log(`Stripe event ${event.id} already processed, skipping`);
        return c.json({ received: true, duplicate: true });
    }
    
    // ========= PROCESS THE EVENT =========
    try {
        switch (event.type) {
            case 'checkout.session.completed':
                await handleCheckoutCompleted(event.data.object);
                break;
            case 'customer.subscription.updated':
                await handleSubscriptionUpdated(event.data.object);
                break;
            case 'customer.subscription.deleted':
                await handleSubscriptionDeleted(event.data.object);
                break;
            case 'invoice.payment_succeeded':
                await handlePaymentSucceeded(event.data.object);
                break;
            // ... other event types
        }
        
        // ========= MARK AS PROCESSED =========
        await db.insert(webhookEvents).values({
            provider: 'stripe',
            eventId: event.id,
            eventType: event.type,
        });
        
        return c.json({ received: true });
        
    } catch (error) {
        console.error(`Error processing Stripe event ${event.id}:`, error);
        // Don't mark as processed - allow retry
        return c.text('Processing failed', 500);
    }
});
```

---

## Key Points

1. **Check BEFORE processing** - Avoid any side effects for duplicates
2. **Mark AFTER processing** - If processing fails, we want Stripe to retry
3. **Use transactions** - If your processing involves multiple DB writes, wrap in a transaction
4. **Log duplicates** - Helps with debugging

---

## Acceptance Criteria

- [ ] `webhook_events` table exists (or is created in this PR)
- [ ] Duplicate event IDs are detected and skipped
- [ ] First occurrence processes normally
- [ ] Failed processing does NOT mark event as processed (allows retry)
- [ ] Log message when duplicate is detected

---

## How to Test

### Unit Test

```typescript
describe('Stripe webhook idempotency', () => {
    it('processes first event', async () => {
        const res = await app.request('/api/webhooks/stripe', {
            method: 'POST',
            body: mockStripeEvent('evt_123'),
            headers: { 'stripe-signature': validSig }
        });
        expect(res.status).toBe(200);
        // Verify credits were added
    });
    
    it('skips duplicate event', async () => {
        // First request
        await app.request('/api/webhooks/stripe', {
            method: 'POST', 
            body: mockStripeEvent('evt_456'),
            headers: { 'stripe-signature': validSig }
        });
        
        // Duplicate request
        const res = await app.request('/api/webhooks/stripe', {
            method: 'POST',
            body: mockStripeEvent('evt_456'),
            headers: { 'stripe-signature': validSig }
        });
        
        expect(res.status).toBe(200);
        const json = await res.json();
        expect(json.duplicate).toBe(true);
        // Verify credits were NOT added twice
    });
});
```

### Manual Test

1. Use Stripe CLI to send test events:
   ```bash
   stripe trigger checkout.session.completed
   ```
2. Check that processing happened once
3. Replay the same event and verify it's skipped

---

## Definition of Done

- [ ] Code reviewed
- [ ] Idempotency check implemented
- [ ] Unit tests passing
- [ ] Manual test with Stripe CLI
- [ ] PR merged to main
