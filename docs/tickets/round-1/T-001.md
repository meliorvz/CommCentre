# T-001: Create Tenant-Scoped Database Tables

| Field | Value |
|-------|-------|
| **Status** | ðŸŸ¡ READY |
| **Round** | 1 (No Dependencies) |
| **Effort** | 4-6 hours |
| **Assignee** | _____________ |

---

## Background

This is **Paradise Comms** - a multi-tenant SaaS platform for vacation rental communication. The platform handles SMS, email, and Telegram messages for property management companies, using AI to auto-respond to guest inquiries.

Currently, **ALL companies share the same configuration** because data is stored in Cloudflare KV with global keys. This is a **critical P0 security vulnerability** - one company's admin can change the AI settings, prompts, and knowledge base for ALL companies.

---

## Current State (Problem)

```
Cloudflare KV Keys (NO tenant isolation):
â”œâ”€â”€ settings:global          â† Shared by all companies!
â”œâ”€â”€ knowledge:items          â† Shared by all companies!
â”œâ”€â”€ prompt:business:published â† Shared by all companies!
â”œâ”€â”€ templates:sms:*          â† Shared by all companies!
â””â”€â”€ setup:profile            â† Shared by all companies!
```

When a company admin edits their AI assistant's name, ALL companies see that change. This must be fixed before multi-tenant production.

---

## What This Ticket Achieves

Create new PostgreSQL tables that store configuration **per company**, with proper `company_id` foreign keys. Each company will have isolated:

- AI assistant profile (name, timezone)
- AI behavior settings (confidence threshold, quiet hours)
- System prompts (with version history)
- Knowledge base (FAQ categories and items)
- Message templates
- Property-level settings

---

## Files to Create

### `src/db/migrations/0030_tenant_isolation.sql`

```sql
-- Company profile (identity, brand settings)
CREATE TABLE company_profile (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE UNIQUE,
    assistant_name TEXT NOT NULL DEFAULT 'Mark',
    website_url TEXT,
    timezone TEXT NOT NULL DEFAULT 'Australia/Sydney',
    vertical_id TEXT DEFAULT 'hospitality',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Company AI behavior configuration
CREATE TABLE company_ai_config (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE UNIQUE,
    auto_reply_enabled BOOLEAN DEFAULT true,
    confidence_threshold NUMERIC(3,2) DEFAULT 0.70 
        CHECK (confidence_threshold BETWEEN 0 AND 1),
    quiet_hours_start TIME DEFAULT '22:00',
    quiet_hours_end TIME DEFAULT '08:00',
    response_delay_minutes INTEGER DEFAULT 3 
        CHECK (response_delay_minutes >= 0),
    escalation_categories TEXT[] DEFAULT ARRAY['refund', 'complaint', 'emergency'],
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Company system prompts with version history
CREATE TABLE company_prompts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    version INTEGER NOT NULL CHECK (version > 0),
    is_published BOOLEAN DEFAULT false,
    published_at TIMESTAMPTZ,
    published_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(company_id, version)
);
CREATE INDEX idx_company_prompts_published ON company_prompts(company_id, is_published) 
    WHERE is_published = true;

-- Knowledge base categories per company
CREATE TABLE knowledge_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    slug TEXT NOT NULL,
    display_order INTEGER DEFAULT 0,
    example_questions TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(company_id, slug)
);

-- Knowledge base items (FAQs) per company
CREATE TABLE knowledge_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    category_id UUID REFERENCES knowledge_categories(id) ON DELETE CASCADE,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    display_order INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_knowledge_items_company ON knowledge_items(company_id);

-- Message templates per company
CREATE TABLE company_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    channel TEXT NOT NULL CHECK (channel IN ('sms', 'email')),
    rule_key TEXT NOT NULL CHECK (rule_key IN ('T_MINUS_3', 'T_MINUS_1', 'DAY_OF')),
    subject TEXT,
    body TEXT NOT NULL,
    version INTEGER DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(company_id, channel, rule_key)
);

-- Property-level settings (with company_id for RLS)
CREATE TABLE property_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID REFERENCES properties(id) ON DELETE CASCADE UNIQUE,
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    auto_reply_enabled BOOLEAN DEFAULT true,
    sms_enabled BOOLEAN DEFAULT true,
    email_enabled BOOLEAN DEFAULT true,
    schedule_t3_time TIME DEFAULT '10:00',
    schedule_t1_time TIME DEFAULT '10:00',
    schedule_day_of_time TIME DEFAULT '14:00',
    checkin_time TIME DEFAULT '15:00',
    checkout_time TIME DEFAULT '10:00',
    early_checkin_policy TEXT,
    late_checkout_policy TEXT,
    parking_info TEXT,
    pet_policy TEXT,
    smoking_policy TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Communication events log for audit trail
CREATE TABLE comms_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    channel TEXT NOT NULL CHECK (channel IN ('sms', 'email', 'telegram')),
    direction TEXT NOT NULL CHECK (direction IN ('inbound', 'outbound')),
    from_addr TEXT NOT NULL,
    to_addr TEXT NOT NULL,
    subject TEXT,
    body_preview TEXT,
    status TEXT NOT NULL,
    provider_message_id TEXT,
    provider_status TEXT,
    error_message TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_comms_events_company ON comms_events(company_id, created_at DESC);

-- Webhook events for idempotency (prevent duplicate processing)
CREATE TABLE webhook_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    provider TEXT NOT NULL,
    event_id TEXT NOT NULL,
    event_type TEXT NOT NULL,
    processed_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(provider, event_id)
);
```

---

## Files to Modify

### `src/db/schema.ts`

Add Drizzle ORM schema definitions for each new table. Example pattern:

```typescript
export const companyProfile = pgTable('company_profile', {
    id: uuid('id').primaryKey().defaultRandom(),
    companyId: uuid('company_id')
        .notNull()
        .references(() => companies.id, { onDelete: 'cascade' })
        .unique(),
    assistantName: text('assistant_name').notNull().default('Mark'),
    websiteUrl: text('website_url'),
    timezone: text('timezone').notNull().default('Australia/Sydney'),
    verticalId: text('vertical_id').default('hospitality'),
    createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
    updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow(),
});
```

---

## Acceptance Criteria

- [ ] All tables created with proper foreign keys and `ON DELETE CASCADE`
- [ ] `TIME` types used (not TEXT) for time fields
- [ ] `CHECK` constraints on numeric fields (e.g., confidence_threshold BETWEEN 0 AND 1)
- [ ] Unique constraints where specified
- [ ] Indexes on frequently queried columns
- [ ] Migration runs without errors: `npm run db:migrate`
- [ ] Tables visible in Neon console
- [ ] Drizzle schema definitions added to `schema.ts`

---

## How to Test

```bash
# Run the migration
npm run db:migrate

# Verify in Neon console that all tables exist
# Or connect with psql and run:
\dt company_*
\dt knowledge_*
\dt webhook_events
\dt comms_events
```

---

## Definition of Done

- [ ] Code reviewed by at least one other developer
- [ ] Migration tested on dev database
- [ ] CI passes
- [ ] PR merged to main
