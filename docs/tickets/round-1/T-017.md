# T-017: Add Comms Events Logging

| Field | Value |
|-------|-------|
| **Status** | ðŸŸ¡ READY |
| **Round** | 1 (No Dependencies) |
| **Effort** | 4-6 hours |
| **Assignee** | _____________ |

---

## Background

This platform sends and receives SMS, email, and Telegram messages on behalf of vacation rental companies. Currently, **there's no centralized log of all communications** - messages are tracked in the `messages` table tied to threads, but there's no audit trail for:

- Failed sends
- Inbound messages that didn't match a guest
- System-generated messages (escalations, confirmations)
- Delivery status updates

---

## What This Ticket Achieves

Create a comprehensive **comms_events** log that tracks every inbound and outbound communication for:
- Audit trail (legal/compliance)
- Debugging delivery issues
- Usage analytics
- Billing verification

---

## Database Table

If T-001 isn't merged, include this in your migration:

```sql
CREATE TABLE comms_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    channel TEXT NOT NULL CHECK (channel IN ('sms', 'email', 'telegram')),
    direction TEXT NOT NULL CHECK (direction IN ('inbound', 'outbound')),
    from_addr TEXT NOT NULL,
    to_addr TEXT NOT NULL,
    subject TEXT,
    body_preview TEXT, -- First 500 chars only (privacy)
    status TEXT NOT NULL,
    provider_message_id TEXT,
    provider_status TEXT,
    error_message TEXT,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_comms_events_company ON comms_events(company_id, created_at DESC);
CREATE INDEX idx_comms_events_provider_id ON comms_events(provider_message_id);
```

---

## Implementation

### Create Logger Module

**`src/worker/lib/comms-logger.ts`**

```typescript
import { commsEvents } from '../db/schema';
import { getDb } from '../db';

interface CommsEventInput {
    companyId: string;
    channel: 'sms' | 'email' | 'telegram';
    direction: 'inbound' | 'outbound';
    fromAddr: string;
    toAddr: string;
    subject?: string;
    body?: string;
    status: string;
    providerMessageId?: string;
    providerStatus?: string;
    errorMessage?: string;
    metadata?: Record<string, unknown>;
}

export async function logCommsEvent(env: Env, event: CommsEventInput) {
    const db = getDb(env);
    
    await db.insert(commsEvents).values({
        companyId: event.companyId,
        channel: event.channel,
        direction: event.direction,
        fromAddr: event.fromAddr,
        toAddr: event.toAddr,
        subject: event.subject,
        bodyPreview: event.body?.substring(0, 500), // Truncate for privacy
        status: event.status,
        providerMessageId: event.providerMessageId,
        providerStatus: event.providerStatus,
        errorMessage: event.errorMessage,
        metadata: event.metadata || {},
    });
}
```

---

## Files to Modify

### `src/worker/lib/twilio.ts`

Add logging to sendSms:

```typescript
import { logCommsEvent } from './comms-logger';

export async function sendSms(env: Env, params: SmsParams) {
    const { to, from, body, companyId } = params;
    
    try {
        const result = await twilioClient.messages.create({
            to, from, body
        });
        
        // Log successful send
        await logCommsEvent(env, {
            companyId,
            channel: 'sms',
            direction: 'outbound',
            fromAddr: from,
            toAddr: to,
            body,
            status: 'sent',
            providerMessageId: result.sid,
            providerStatus: result.status,
        });
        
        return result;
    } catch (error) {
        // Log failed send
        await logCommsEvent(env, {
            companyId,
            channel: 'sms',
            direction: 'outbound',
            fromAddr: from,
            toAddr: to,
            body,
            status: 'failed',
            errorMessage: error.message,
        });
        throw error;
    }
}
```

### `src/worker/lib/gmail.ts`

Add logging to sendEmail:

```typescript
export async function sendEmail(env: Env, params: EmailParams) {
    const { to, from, subject, body, companyId } = params;
    
    try {
        const result = await gmailSend(...);
        
        await logCommsEvent(env, {
            companyId,
            channel: 'email',
            direction: 'outbound',
            fromAddr: from,
            toAddr: to,
            subject,
            body,
            status: 'sent',
            providerMessageId: result.id,
        });
        
        return result;
    } catch (error) {
        await logCommsEvent(env, {
            companyId,
            channel: 'email',
            direction: 'outbound',
            fromAddr: from,
            toAddr: to,
            subject,
            body,
            status: 'failed',
            errorMessage: error.message,
        });
        throw error;
    }
}
```

### `src/worker/routes/webhooks/twilio.ts`

Log inbound SMS:

```typescript
async function handleInboundSms(c: Context) {
    const body = c.get('twilioBody');
    const companyId = await lookupCompanyFromNumber(body.To);
    
    await logCommsEvent(c.env, {
        companyId: companyId || 'unknown',
        channel: 'sms',
        direction: 'inbound',
        fromAddr: body.From,
        toAddr: body.To,
        body: body.Body,
        status: 'received',
        providerMessageId: body.MessageSid,
    });
    
    // ... rest of handler
}
```

### `src/worker/email-handler.ts`

Log inbound emails:

```typescript
async function handleInboundEmail(message: ForwardableEmailMessage, env: Env) {
    const companyId = await lookupCompanyFromEmail(message.to);
    
    await logCommsEvent(env, {
        companyId: companyId || 'unknown',
        channel: 'email',
        direction: 'inbound',
        fromAddr: message.from,
        toAddr: message.to,
        subject: message.headers.get('subject'),
        status: 'received',
    });
    
    // ... rest of handler
}
```

---

## Acceptance Criteria

- [ ] `comms_events` table created (or exists from T-001)
- [ ] All outbound SMS logged (success and failure)
- [ ] All outbound emails logged (success and failure)
- [ ] All inbound SMS logged
- [ ] All inbound emails logged
- [ ] Body truncated to 500 chars for privacy
- [ ] Events queryable by company_id

---

## How to Test

1. Send an SMS via the platform â†’ check comms_events table
2. Receive an inbound SMS â†’ check comms_events table
3. Force a send failure â†’ verify error logged

```sql
SELECT * FROM comms_events 
WHERE company_id = 'xxx' 
ORDER BY created_at DESC 
LIMIT 10;
```

---

## Definition of Done

- [ ] Code reviewed
- [ ] Logging added to all send/receive paths
- [ ] Manual tests passing
- [ ] PR merged to main
