# T-008: Implement Twilio Signature Validation

| Field | Value |
|-------|-------|
| **Status** | ðŸŸ¡ READY |
| **Round** | 1 (No Dependencies) |
| **Effort** | 4-6 hours |
| **Assignee** | _____________ |

---

## Background

This platform receives **webhooks from Twilio** for:
- Inbound SMS messages from guests
- SMS delivery status updates
- Inbound voice calls
- Call status updates

Currently, **anyone who knows the webhook URL can send fake requests** pretending to be Twilio. This is a **P0 security vulnerability** that could allow attackers to:
- Inject fake messages into guest conversations
- Trigger actions as if a real SMS was received
- Manipulate message delivery statuses

---

## Current State (Problem)

```typescript
// src/worker/routes/webhooks/twilio.ts

// NO SIGNATURE VALIDATION! Anyone can POST to this endpoint
app.post('/api/webhooks/twilio/sms', async (c) => {
    const body = await c.req.parseBody();
    // Processes the request as if it came from Twilio...
});
```

Twilio sends an `X-Twilio-Signature` header with every webhook. We're not checking it.

---

## What This Ticket Achieves

Validate the `X-Twilio-Signature` header on all Twilio webhooks. Invalid or missing signatures will be rejected with 403 Forbidden.

---

## How Twilio Signature Validation Works

Twilio signs each webhook request using HMAC-SHA1:

1. Twilio concatenates the webhook URL + all POST parameters (sorted alphabetically)
2. Twilio computes HMAC-SHA1 using your Auth Token as the key
3. Twilio base64-encodes the result and sends it in `X-Twilio-Signature`
4. You repeat the same calculation and compare signatures

---

## Files to Create

### `src/worker/lib/twilio-signature.ts`

```typescript
import { createHmac } from 'crypto';

/**
 * Validates a Twilio webhook signature
 * 
 * @param authToken - Your Twilio Auth Token (from env.TWILIO_AUTH_TOKEN)
 * @param signature - The X-Twilio-Signature header value
 * @param url - The full webhook URL (must match what Twilio used)
 * @param params - The POST body as key-value pairs
 * @returns true if signature is valid
 */
export function validateTwilioSignature(
    authToken: string,
    signature: string,
    url: string,
    params: Record<string, string>
): boolean {
    if (!signature || !authToken) {
        return false;
    }

    // Sort parameters alphabetically and concatenate
    const sortedKeys = Object.keys(params).sort();
    let data = url;
    for (const key of sortedKeys) {
        data += key + params[key];
    }

    // Compute HMAC-SHA1
    const expectedSignature = createHmac('sha1', authToken)
        .update(data)
        .digest('base64');

    // Timing-safe comparison
    return timingSafeEqual(signature, expectedSignature);
}

function timingSafeEqual(a: string, b: string): boolean {
    if (a.length !== b.length) return false;
    
    let result = 0;
    for (let i = 0; i < a.length; i++) {
        result |= a.charCodeAt(i) ^ b.charCodeAt(i);
    }
    return result === 0;
}
```

---

## Files to Modify

### `src/worker/routes/webhooks/twilio.ts`

Add signature validation to all Twilio webhook handlers:

```typescript
import { validateTwilioSignature } from '../lib/twilio-signature';

// Create middleware for Twilio signature validation
async function validateTwilioRequest(c: Context, next: Next) {
    const signature = c.req.header('X-Twilio-Signature');
    const body = await c.req.parseBody() as Record<string, string>;
    
    // Reconstruct the full URL (important: must match what Twilio sees)
    const url = new URL(c.req.url);
    // Use the public URL, not internal worker URL
    const webhookUrl = `${c.env.WORKER_BASE_URL}${url.pathname}`;
    
    const isValid = validateTwilioSignature(
        c.env.TWILIO_AUTH_TOKEN,
        signature || '',
        webhookUrl,
        body
    );
    
    if (!isValid) {
        console.warn('Invalid Twilio signature', {
            path: url.pathname,
            hasSignature: !!signature
        });
        return c.text('Forbidden', 403);
    }
    
    // Store parsed body for handler to use
    c.set('twilioBody', body);
    await next();
}

// Apply to all Twilio webhooks
app.post('/api/webhooks/twilio/sms', validateTwilioRequest, handleInboundSms);
app.post('/api/webhooks/twilio/sms/status', validateTwilioRequest, handleSmsStatus);
app.post('/api/webhooks/twilio/voice', validateTwilioRequest, handleInboundVoice);
app.post('/api/webhooks/twilio/voice/status', validateTwilioRequest, handleVoiceStatus);
```

---

## Environment Variable Required

Add `WORKER_BASE_URL` to your environment:

```bash
# Example for production
WORKER_BASE_URL=https://comms-centre.workers.dev

# Example for development  
WORKER_BASE_URL=https://comms-centre.ancient-fire-eaa9.workers.dev
```

This is needed because the Worker sees an internal URL, but Twilio uses the public URL when computing the signature.

---

## Acceptance Criteria

- [ ] `validateTwilioSignature` function implemented with timing-safe comparison
- [ ] All 4 Twilio webhook endpoints check signature
- [ ] Missing signature returns 403
- [ ] Invalid signature returns 403
- [ ] Valid signature proceeds to handler
- [ ] `WORKER_BASE_URL` environment variable added to wrangler.toml

---

## How to Test

### 1. Unit Test for Signature Validation

```typescript
describe('validateTwilioSignature', () => {
    it('validates correct signature', () => {
        const authToken = 'test_auth_token';
        const url = 'https://example.com/webhook';
        const params = { Body: 'Hello', From: '+1234567890' };
        
        // Pre-computed valid signature for this input
        const validSignature = '...'; // Compute this once
        
        expect(validateTwilioSignature(authToken, validSignature, url, params)).toBe(true);
    });
    
    it('rejects invalid signature', () => {
        expect(validateTwilioSignature('token', 'wrong', 'https://x.com', {})).toBe(false);
    });
});
```

### 2. Integration Test

```bash
# Send a request WITHOUT signature - should get 403
curl -X POST https://your-worker.workers.dev/api/webhooks/twilio/sms \
  -d "Body=Test" -d "From=+1234567890"
# Expected: 403 Forbidden

# Send with VALID signature - should get 200
# (Use Twilio's actual webhook for this test)
```

---

## Definition of Done

- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Integration test with real Twilio webhook
- [ ] Forged request test (should be rejected)
- [ ] PR merged to main
