# T-015: Remove Dangerous Twilio From Number Fallback

| Field | Value |
|-------|-------|
| **Status** | üî¥ BLOCKED |
| **Round** | 2 |
| **Blocked By** | T-001 ‚úÖ |
| **Effort** | 6-8 hours |
| **Assignee** | _____________ |

---

## Background

When sending an SMS, the platform needs to use a **From** phone number. Currently, there's a dangerous fallback mechanism:

```typescript
// src/worker/lib/twilio.ts

export async function getValidatedFromNumber(env: Env, configuredNumber?: string): Promise<string> {
    const validNumbers = await getValidTwilioNumbers(env);

    // 1. Try configured number
    if (configuredNumber && validNumbers.includes(configuredNumber)) {
        return configuredNumber;
    }

    // 2. Fallback to first valid number (DANGEROUS!)
    if (validNumbers.length > 0) {
        console.warn(`Falling back to ${validNumbers[0]}`);
        return validNumbers[0]; // ‚Üê Could be ANY company's number!
    }

    // 3. Fallback to env var
    if (env.TWILIO_FROM_NUMBER) {
        return env.TWILIO_FROM_NUMBER;
    }

    throw new Error('No valid Twilio phone number available');
}
```

**Problem**: If a company's configured number is invalid, the system falls back to the **first number in the account** - which could belong to a different company!

---

## What This Ticket Achieves

1. Remove the dangerous fallback logic
2. Validate that the From number belongs to the requesting company
3. Only fallback to a platform-owned escalation number
4. Throw hard errors for invalid configurations

---

## Implementation

**`src/worker/lib/twilio.ts`**

```typescript
import { companyPhoneNumbers } from '../db/schema';
import { eq, and } from 'drizzle-orm';

/**
 * Get a validated From number for outbound SMS
 * 
 * Priority:
 * 1. Requested number if owned by company
 * 2. Company's primary number
 * 3. Platform escalation number (last resort)
 * 
 * @throws Error if no valid number available
 */
export async function getValidatedFromNumber(
    env: Env,
    companyId: string,
    preferredNumber?: string
): Promise<{ number: string; isPlatformNumber: boolean }> {
    const db = getDb(env);
    
    // Get all phone numbers owned by this company
    const companyNumbers = await db.select()
        .from(companyPhoneNumbers)
        .where(and(
            eq(companyPhoneNumbers.companyId, companyId),
            eq(companyPhoneNumbers.isActive, true)
        ));
    
    const ownedNumbers = companyNumbers.map(n => n.phoneNumber);
    
    // Option 1: Use preferred number if company owns it
    if (preferredNumber && ownedNumbers.includes(preferredNumber)) {
        return { number: preferredNumber, isPlatformNumber: false };
    }
    
    // Option 2: Use company's primary number
    const primaryNumber = companyNumbers.find(n => n.isPrimary);
    if (primaryNumber) {
        return { number: primaryNumber.phoneNumber, isPlatformNumber: false };
    }
    
    // Option 3: Use any company-owned number
    if (companyNumbers.length > 0) {
        return { number: companyNumbers[0].phoneNumber, isPlatformNumber: false };
    }
    
    // Option 4: Use platform escalation number (for free tier)
    if (env.PLATFORM_ESCALATION_NUMBER) {
        console.warn(`Company ${companyId} has no phone numbers, using platform number`);
        return { number: env.PLATFORM_ESCALATION_NUMBER, isPlatformNumber: true };
    }
    
    // No valid option - hard fail
    throw new Error(`No valid From number for company ${companyId}`);
}
```

---

## Update sendSms Function

**`src/worker/lib/twilio.ts`**

```typescript
interface SendSmsParams {
    to: string;
    body: string;
    companyId: string;  // REQUIRED now
    preferredFrom?: string;
}

export async function sendSms(env: Env, params: SendSmsParams): Promise<TwilioMessage> {
    const { to, body, companyId, preferredFrom } = params;
    
    // Get validated From number
    const { number: from, isPlatformNumber } = await getValidatedFromNumber(
        env, 
        companyId, 
        preferredFrom
    );
    
    // If using platform number, prepend company name for context
    let messageBody = body;
    if (isPlatformNumber) {
        const company = await getCompanyName(env, companyId);
        messageBody = `[From ${company}] ${body}`;
    }
    
    const client = getTwilioClient(env);
    
    const result = await client.messages.create({
        to,
        from,
        body: messageBody,
    });
    
    // Log the send (T-017)
    await logCommsEvent(env, {
        companyId,
        channel: 'sms',
        direction: 'outbound',
        fromAddr: from,
        toAddr: to,
        body: messageBody,
        status: 'sent',
        providerMessageId: result.sid,
        metadata: { isPlatformNumber },
    });
    
    return result;
}
```

---

## Environment Variable

Add platform escalation number:

```bash
npx wrangler secret put PLATFORM_ESCALATION_NUMBER
# Enter your platform-owned Twilio number, e.g., +61400000000
```

---

## Acceptance Criteria

- [ ] `sendSms` requires `companyId` parameter
- [ ] From number validated against `company_phone_numbers` table
- [ ] Preferred number must be owned by company
- [ ] Fallback only to platform escalation number
- [ ] Hard error if no valid number available
- [ ] Platform number messages prepend company name
- [ ] Test: Company A can't send from Company B's number

---

## How to Test

```typescript
// Test: Company can use own number
it('allows company to use their own number', async () => {
    await createPhoneNumber({ companyId: 'c1', phoneNumber: '+61400111111' });
    
    const result = await getValidatedFromNumber(env, 'c1', '+61400111111');
    expect(result.number).toBe('+61400111111');
    expect(result.isPlatformNumber).toBe(false);
});

// Test: Company cannot use another company's number
it('rejects other company number', async () => {
    await createPhoneNumber({ companyId: 'c1', phoneNumber: '+61400111111' });
    await createPhoneNumber({ companyId: 'c2', phoneNumber: '+61400222222' });
    
    // Company 1 tries to use Company 2's number
    const result = await getValidatedFromNumber(env, 'c1', '+61400222222');
    // Should NOT return +61400222222
    expect(result.number).not.toBe('+61400222222');
});

// Test: Falls back to platform number when company has none
it('uses platform number for numberless company', async () => {
    const result = await getValidatedFromNumber(env, 'c-no-numbers');
    expect(result.number).toBe(env.PLATFORM_ESCALATION_NUMBER);
    expect(result.isPlatformNumber).toBe(true);
});
```

---

## Definition of Done

- [ ] Code reviewed
- [ ] Dangerous fallback removed
- [ ] Ownership validation implemented
- [ ] Platform number fallback works
- [ ] Tests passing
- [ ] PR merged to main
