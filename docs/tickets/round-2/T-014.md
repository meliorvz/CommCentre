# T-014: Fix SQL Injection in SMS Status Callback

| Field | Value |
|-------|-------|
| **Status** | ðŸ”´ BLOCKED |
| **Round** | 2 |
| **Blocked By** | T-008 âœ… |
| **Effort** | 1-2 hours |
| **Assignee** | _____________ |

---

## Background

A security reviewer found a **SQL injection vulnerability** in the SMS status callback handler. This is a P0 security issue.

---

## Current State (DANGEROUS)

```typescript
// src/worker/routes/webhooks/twilio.ts

app.post('/api/webhooks/twilio/sms/status', async (c) => {
    const body = await c.req.parseBody();
    const messageSid = body.MessageSid;
    const status = body.MessageStatus;
    
    // VULNERABLE! Direct string interpolation
    await db.execute(
        `UPDATE messages SET status = '${status}' WHERE provider_message_id = '${messageSid}'`
    );
    
    return c.text('OK');
});
```

An attacker could send a crafted webhook with:
```
MessageStatus=delivered'; DROP TABLE messages; --
```

---

## What This Ticket Achieves

Replace the raw SQL string with a parameterized Drizzle query.

---

## Implementation

**`src/worker/routes/webhooks/twilio.ts`**

```typescript
import { messages } from '../db/schema';
import { eq } from 'drizzle-orm';

app.post('/api/webhooks/twilio/sms/status', async (c) => {
    const body = c.get('twilioBody'); // Validated by T-008 middleware
    const messageSid = body.MessageSid as string;
    const status = body.MessageStatus as string;
    
    // Validate status is one of expected values
    const validStatuses = ['queued', 'sending', 'sent', 'delivered', 'failed', 'undelivered'];
    if (!validStatuses.includes(status)) {
        console.warn(`Invalid message status: ${status}`);
        return c.text('Invalid status', 400);
    }
    
    const db = getDb(c.env);
    
    // SAFE: Parameterized query via Drizzle
    await db.update(messages)
        .set({ 
            status,
            updatedAt: new Date(),
        })
        .where(eq(messages.providerMessageId, messageSid));
    
    return c.text('OK');
});
```

---

## Why This Is Safe

Drizzle ORM uses parameterized queries under the hood:

```sql
-- What Drizzle generates:
UPDATE messages SET status = $1, updated_at = $2 WHERE provider_message_id = $3
-- Parameters: ['delivered', '2024-01-04T12:00:00Z', 'SM123...']
```

The values are never interpolated into the SQL string - they're sent as separate parameters to the database driver.

---

## Additional Hardening

Add status value validation:

```typescript
// Define allowed values
const MESSAGE_STATUSES = ['queued', 'sending', 'sent', 'delivered', 'failed', 'undelivered'] as const;
type MessageStatus = typeof MESSAGE_STATUSES[number];

function isValidStatus(status: string): status is MessageStatus {
    return MESSAGE_STATUSES.includes(status as MessageStatus);
}

// Use in handler
if (!isValidStatus(status)) {
    return c.text('Invalid status', 400);
}
```

---

## Acceptance Criteria

- [ ] Raw SQL replaced with Drizzle parameterized query
- [ ] Status value validated before use
- [ ] No string interpolation in any SQL
- [ ] Status updates still work correctly

---

## How to Test

```typescript
// Test that update works
it('updates message status', async () => {
    // Create a message
    const msg = await createMessage({ providerMessageId: 'SM123', status: 'queued' });
    
    // Simulate status callback
    await app.request('/api/webhooks/twilio/sms/status', {
        method: 'POST',
        body: new URLSearchParams({
            MessageSid: 'SM123',
            MessageStatus: 'delivered',
        }),
        headers: { 'X-Twilio-Signature': validSig },
    });
    
    // Verify update
    const updated = await db.select().from(messages).where(eq(messages.id, msg.id));
    expect(updated[0].status).toBe('delivered');
});

// Test that invalid status is rejected
it('rejects invalid status', async () => {
    const res = await app.request('/api/webhooks/twilio/sms/status', {
        method: 'POST',
        body: new URLSearchParams({
            MessageSid: 'SM123',
            MessageStatus: "'; DROP TABLE messages; --",
        }),
        headers: { 'X-Twilio-Signature': validSig },
    });
    
    expect(res.status).toBe(400);
});
```

---

## Note on Dependency

This ticket depends on T-008 (Twilio signature validation) because without signature validation, attackers could still send malicious payloads. The signature validation is the first line of defense; the parameterized query is defense-in-depth.

---

## Definition of Done

- [ ] Code reviewed
- [ ] No string interpolation in SQL
- [ ] Tests passing
- [ ] PR merged to main
