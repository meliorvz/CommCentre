# T-025: Migrate Telegram to Per-Tenant Tokens

| Field | Value |
|-------|-------|
| **Status** | üî¥ BLOCKED |
| **Round** | 2 |
| **Blocked By** | T-023 ‚úÖ |
| **Effort** | 4-6 hours |
| **Assignee** | _____________ |

---

## Background

Telegram is used for **escalations** - when the AI detects an urgent message or a topic it can't handle, it notifies the property manager via Telegram.

Currently, the Telegram chat ID is a global environment variable:

```typescript
const chatId = env.TELEGRAM_CHAT_ID; // ALL escalations go here!
```

This means all companies' escalations go to the **same Telegram chat**.

---

## What This Ticket Achieves

Store Telegram chat ID per-company so each company's escalations go to their own Telegram chat.

---

## Implementation

### Update Telegram Setup

When a company admin connects Telegram (via deep link):

**`src/worker/routes/webhooks/telegram.ts`**

```typescript
import { storeIntegration } from '../lib/integrations';

// Handle /start command with setup code
async function handleStartCommand(env: Env, message: TelegramMessage) {
    const text = message.text || '';
    const match = text.match(/^\/start\s+(.+)$/);
    
    if (!match) {
        return sendTelegramMessage(env, message.chat.id, 
            'Welcome! Use the setup link from your Paradise Comms dashboard to connect.');
        return;
    }
    
    const setupCode = match[1];
    
    // Look up setup code
    const db = getDb(env);
    const [codeRecord] = await db.select()
        .from(telegramSetupCodes)
        .where(and(
            eq(telegramSetupCodes.code, setupCode),
            gt(telegramSetupCodes.expiresAt, new Date())
        ))
        .limit(1);
    
    if (!codeRecord) {
        await sendTelegramMessage(env, message.chat.id,
            '‚ùå Invalid or expired setup code. Please get a new link from your dashboard.');
        return;
    }
    
    const companyId = codeRecord.companyId;
    const chatId = message.chat.id.toString();
    
    // Store Telegram integration for this company (using T-023)
    await storeIntegration(env, companyId, 'telegram', {
        chatId,
        chatType: message.chat.type,
        title: message.chat.title || `${message.from?.first_name}'s chat`,
    }, chatId);
    
    // Mark setup code as used
    await db.delete(telegramSetupCodes)
        .where(eq(telegramSetupCodes.code, setupCode));
    
    // Audit log
    await logAudit(env, {
        companyId,
        action: 'integration.connected',
        resourceType: 'integration',
        resourceId: 'telegram',
        afterState: { chatId },
    });
    
    // Confirm to user
    await sendTelegramMessage(env, message.chat.id,
        '‚úÖ Connected! You will receive escalations and alerts here.');
}
```

---

### Update Escalation Function

**`src/worker/lib/telegram.ts`**

```typescript
import { getIntegration } from './integrations';

interface TelegramConfig {
    chatId: string;
    chatType: string;
}

/**
 * Send escalation to a company's Telegram chat
 */
export async function sendEscalation(
    env: Env, 
    companyId: string, 
    message: string
): Promise<boolean> {
    const telegram = await getIntegration(env, companyId, 'telegram') as TelegramConfig;
    
    if (!telegram) {
        console.warn(`Company ${companyId} has no Telegram connected`);
        // Could fall back to email escalation, or store for later
        return false;
    }
    
    return sendTelegramMessage(env, telegram.chatId, message);
}

/**
 * Low-level message sending
 */
export async function sendTelegramMessage(
    env: Env,
    chatId: string,
    text: string,
    options: { parseMode?: 'HTML' | 'Markdown' } = {}
): Promise<boolean> {
    const response = await fetch(
        `https://api.telegram.org/bot${env.TELEGRAM_BOT_TOKEN}/sendMessage`,
        {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                text,
                parse_mode: options.parseMode,
            }),
        }
    );
    
    if (!response.ok) {
        const error = await response.text();
        console.error(`Telegram send failed: ${error}`);
        return false;
    }
    
    return true;
}
```

---

### Create Setup Code Table

```sql
CREATE TABLE telegram_setup_codes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    code TEXT NOT NULL UNIQUE,
    created_by UUID REFERENCES users(id),
    expires_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_telegram_codes_lookup ON telegram_setup_codes(code, expires_at);
```

---

### Setup Code Generation Endpoint

**`src/worker/routes/telegram-setup.ts`**

```typescript
app.post('/api/telegram/setup-code', authMiddleware, async (c) => {
    const companyId = c.get('companyId');
    const userId = c.get('user').id;
    
    // Generate random code
    const code = crypto.randomUUID().replace(/-/g, '').slice(0, 16);
    
    // Store with 15 minute expiry
    await db.insert(telegramSetupCodes).values({
        companyId,
        code,
        createdBy: userId,
        expiresAt: new Date(Date.now() + 15 * 60 * 1000),
    });
    
    // Return deep link
    const deepLink = `https://t.me/${c.env.TELEGRAM_BOT_USERNAME}?start=${code}`;
    
    return c.json({ deepLink, code, expiresIn: 900 });
});

// Check connection status
app.get('/api/telegram/status', authMiddleware, async (c) => {
    const companyId = c.get('companyId');
    
    const telegram = await getIntegration(c.env, companyId, 'telegram');
    
    return c.json({
        connected: !!telegram,
        chatId: telegram?.chatId,
    });
});
```

---

## Acceptance Criteria

- [ ] Telegram setup stores chat_id per company
- [ ] Escalations route to company's own chat
- [ ] Setup code generation endpoint works
- [ ] Deep link opens Telegram correctly
- [ ] Code expires after 15 minutes
- [ ] Status endpoint shows connection state
- [ ] Global `TELEGRAM_CHAT_ID` no longer used for tenant operations

---

## How to Test

1. Company A generates setup code
2. Admin clicks deep link, starts bot
3. Verify chat_id stored in company_integrations
4. Trigger an escalation for Company A
5. Verify message arrives in Company A's chat
6. Repeat for Company B - verify separate chat

---

## Definition of Done

- [ ] Code reviewed
- [ ] Setup code flow working
- [ ] Per-company chat storage working
- [ ] Escalations route correctly
- [ ] PR merged to main
